<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pel√≠culas con Temporizador</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #e50914;
      --dark-bg: #141414;
      --header-bg: #0c0c0c;
      --text-color: #fff;
      --secondary-bg: #222;
      --hover-color: #e50914;
      --highlight-bg: rgba(255, 255, 255, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--dark-bg);
      color: var(--text-color);
      padding: 0;
      margin: 0;
      line-height: 1.5;
    }
    
    header {
      background-color: var(--header-bg);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      color: var(--primary-color);
      font-size: 2rem;
      font-weight: bold;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    .user-info {
      background: rgba(0, 0, 0, 0.7);
      padding: 20px;
      border-radius: 8px;
      margin: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .user-data {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-balance {
      font-size: 1.2rem;
      font-weight: bold;
      color: #4BB543;
    }
    
    #contador {
      font-size: 1.2rem;
      margin: 20px;
      padding: 12px;
      background: rgba(229, 9, 20, 0.2);
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
      color: #fff;
      text-align: center;
      font-weight: bold;
    }
    
    .warning-banner {
      background: linear-gradient(to right, #ff8a00, #e52e71);
      color: white;
      padding: 20px;
      margin: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }
    
    .warning-icon {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
      text-align: center;
    }
    
    .warning-title {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .ad-banner {
      margin: 20px;
      text-align: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .button-container {
      display: flex;
      gap: 10px;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    
    .dashboard-btn, .logout-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .dashboard-btn {
      background-color: var(--primary-color);
      color: white;
    }
    
    .dashboard-btn:hover {
      background-color: #f40612;
    }
    
    .logout-btn {
      background-color: rgba(255,255,255,0.2);
      color: white;
    }
    
    .logout-btn:hover {
      background-color: rgba(255,255,255,0.3);
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: rgba(75, 181, 67, 0.9);
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      animation: slideIn 0.5s forwards;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .search-container {
      margin: 20px;
      position: relative;
    }
    
    .search-container input {
      width: 100%;
      padding: 12px 20px;
      border-radius: 30px;
      border: none;
      background-color: var(--secondary-bg);
      color: var(--text-color);
      font-size: 1rem;
      padding-left: 40px;
    }
    
    .search-container i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,0.5);
    }
    
    .peliculas-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    
    .pelicula {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.3s, box-shadow 0.3s;
      display: flex;
      flex-direction: column;
      height: 100%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .pelicula:hover {
      transform: translateY(-10px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    
    .pelicula img {
      width: 100%;
      height: 450px;
      object-fit: cover;
      transition: opacity 0.3s;
    }
    
    .pelicula:hover img {
      opacity: 0.7;
    }
    
    .pelicula-info {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    
    .pelicula h3 {
      margin: 0 0 10px;
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    .pelicula p {
      font-size: 0.95rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 15px;
      flex-grow: 1;
    }
    
    .pelicula button {
      padding: 12px;
      border: none;
      border-radius: 5px;
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: background-color 0.3s;
      margin-top: auto;
    }
    
    .pelicula button:hover {
      background-color: #f40612;
    }
    
    .check-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
    }
    
    .check-item i {
      color: #4BB543;
      margin-right: 10px;
    }
    
    .disclaimer {
      font-style: italic;
      color: rgba(255,255,255,0.7);
      margin-top: 10px;
      font-size: 0.9rem;
    }
    
    .empty-search {
      text-align: center;
      padding: 40px;
      grid-column: 1 / -1;
    }
    
    .bottom-ad {
      margin-top: 40px;
      margin-bottom: 40px;
      padding: 20px;
      text-align: center;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">MovieFlix</div>
    <div class="header-buttons">
      <button class="dashboard-btn" onclick="irAlDashboard()">Dashboard</button>
      <button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </header>
  
  <div class="user-info">
    <div class="user-data">
      <div>
        <p>Correo: <span id="email">Cargando...</span></p>
      </div>
      <div class="user-balance">
        <p>Saldo: S/ <span id="saldo">Cargando...</span></p>
      </div>
    </div>
  </div>
  
  <!-- Banner de anuncios superior -->
  <div class="ad-banner">
    <script type="text/javascript">
      atOptions = {
        'key' : 'b330ccd204185aee9ef640adccf896d2',
        'format' : 'iframe',
        'height' : 90,
        'width' : 728,
        'params' : {}
      };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/b330ccd204185aee9ef640adccf896d2/invoke.js"></script>
  </div>
  
  <div class="warning-banner">
    <span class="warning-icon">‚ö†Ô∏è</span>
    <h3 class="warning-title">¬°Advertencia! Est√°s a punto de ganar dinero viendo una pel√≠cula üçøüí∏</h3>
    <p>S√≠, le√≠ste bien. Cada vez que ves una pel√≠cula en esta plataforma con anuncios, <strong>se genera ingreso</strong>‚Ä¶ ü´¢ <em>¬øY sabes qui√©n gana m√°s que nosotros?</em> üëâ ¬°<strong>T√∫!</strong></p>
    <div style="margin-top: 15px;">
      <div class="check-item">
        <i class="fas fa-check-circle"></i>
        <span>Porque no pagas ni un sol.</span>
      </div>
      <div class="check-item">
        <i class="fas fa-check-circle"></i>
        <span>Porque accedes a pel√≠culas completas sin restricciones.</span>
      </div>
      <div class="check-item">
        <i class="fas fa-check-circle"></i>
        <span>Porque solo con mirar, <strong>generas ingresos que hacen posible este sitio</strong>.</span>
      </div>
      <div class="check-item">
        <i class="fas fa-check-circle"></i>
        <span>Porque si todos saltaran los anuncios, <strong>no existir√≠a esta p√°gina</strong>.</span>
      </div>
    </div>
    <p class="disclaimer">üîê Si eliges el modo sin anuncios, tendr√°s acceso limitado. Pero si ves con anuncios, <strong>t√∫ est√°s financiando tu propio entretenimiento</strong>. <em>¬øQui√©n m√°s te paga por mirar pelis?</em></p>
  </div>
  
  <div id="notification" class="notification">¬°Recompensa exitosa! Se ha a√±adido 0.003 a tu saldo.</div>
  
  <p id="contador">Tiempo restante: --</p>
  
  <div class="search-container">
    <i class="fas fa-search"></i>
    <input type="text" id="buscador" placeholder="Buscar pel√≠culas..." oninput="filtrarPeliculas()">
  </div>
  
  <div id="peliculas-container" class="peliculas-container">
    <!-- Las pel√≠culas se generar√°n din√°micamente -->
  </div>
  
  <!-- Banner de anuncios lateral -->
  <div class="ad-banner">
    <script type="text/javascript">
      atOptions = {
        'key' : 'a55c7cdc78df0520f71c2b00e4046167',
        'format' : 'iframe',
        'height' : 300,
        'width' : 160,
        'params' : {}
      };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/a55c7cdc78df0520f71c2b00e4046167/invoke.js"></script>
  </div>
  
  <!-- Banner de anuncios inferior -->
  <div class="bottom-ad">
    <script async="async" data-cfasync="false" src="//pl26063295.profitableratecpm.com/2537ae2ea8b16bc9e554273a94dfd098/invoke.js"></script>
    <div id="container-2537ae2ea8b16bc9e554273a94dfd098"></div>
  </div>
  
  <script>
    // Configuraci√≥n de Supabase con tus credenciales
    const SUPABASE_URL = "https://srormesvqserhrfugrls.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyb3JtZXN2cXNlcmhyZnVncmxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMzNTk0MzUsImV4cCI6MjA1ODkzNTQzNX0.zGjT9CbTd6jb1lEBzK3OrsZJIgZSqJH9zfLXzWvLTlM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Lista de pel√≠culas
    const peliculas = [
      {
        id: 1,
        titulo: "Bajo custodia",
        imagen: "https://pics.filmaffinity.com/Bajo_custodia-198204017-large.jpg",
        descripcion: "Una mujer enigm√°tica despierta dentro de una comisar√≠a abandonada en medio de la noche sin recordar c√≥mo lleg√≥ all√≠. Dos detectives intentan reconstruir sus pasos para acusarla de un atropello.",
        url: "https://do7go.com/e/utfh2cbr2q7a"
      },
      {
        id: 2,
        titulo: "Equipaje de mano",
        imagen: "https://images.justwatch.com/poster/322836177/s166/equipaje-de-mano-2024.avif",
        descripcion: "El d√≠a de Nochebuena, en el concurrido aeropuerto de Los Angeles, un desconocido chantajea a un joven agente para que le deje subir una misteriosa maleta al avi√≥n.",
        url: "https://mega.nz/file/g1JVhJIa#blYnA6tfvZfuMvuOk66dwTb9X-aSSmwARAMHrMfV7e8"
      },
      {
        id: 3,
        titulo: "Avatar: El sentido del agua",
        imagen: "https://pics.filmaffinity.com/Avatar_El_sentido_del_agua-72202567-large.jpg",
        descripcion: "Jake Sully y Ney'tiri han formado una familia y hacen todo lo posible por permanecer juntos. Sin embargo, deben abandonar su hogar y explorar las regiones de Pandora cuando una antigua amenaza reaparece.",
        url: "https://do7go.com/e/x89nj2qm7bde"
      },
      {
        id: 4,
        titulo: "Furiosa: De la saga Mad Max",
        imagen: "https://pics.filmaffinity.com/Furiosa_De_la_saga_Mad_Max-839472013-large.jpg",
        descripcion: "La historia de origen de la guerrera Furiosa antes de unirse a Mad Max en Fury Road. Secuestrada del Verde Lugar de las Muchas Madres, cae en manos de una gran Horda de Motoristas liderada por el Se√±or de la Guerra Dementus.",
        url: "https://do7go.com/e/r3xtzbpj9o26"
      }
    ];
    
    const tiempoMax = 90 * 60 * 1000; // 1 hora 30 min en milisegundos
    let timer = null;
    let userId = null;
    let peliculaVentana = null;
    let contadorPausado = false;
    
    // Funci√≥n para formatear un n√∫mero a 3 decimales
    function formatearSaldo(saldo) {
      return parseFloat(saldo).toFixed(3);
    }
    
    // Funci√≥n para cargar los datos del usuario
    document.addEventListener("DOMContentLoaded", async () => {
      // Verificar autenticaci√≥n
      const { data: { user }, error } = await supabase.auth.getUser();
      
      if (error || !user) {
        alert("No has iniciado sesi√≥n");
        window.location.href = "login.html";
        return;
      }
      
      // Guardar ID del usuario para uso posterior
      userId = user.id;
      
      // Mostrar email del usuario
      document.getElementById("email").textContent = user.email;
      
      // Obtener saldo
      const { data, error: balanceError } = await supabase
        .from("users")
        .select("balance")
        .eq("id", user.id)
        .single();
      
      if (balanceError || !data) {
        document.getElementById("saldo").textContent = "0.000";
      } else {
        document.getElementById("saldo").textContent = formatearSaldo(data.balance);
      }
      
      // Cargar pel√≠culas
      cargarPeliculas(peliculas);
      
      // Verificar si hay un temporizador activo
      verificarTemporizadorActivo();
    });
    
    // Funci√≥n para cargar pel√≠culas
    function cargarPeliculas(listaPeliculas) {
      const contenedor = document.getElementById("peliculas-container");
      contenedor.innerHTML = "";
      
      if (listaPeliculas.length === 0) {
        contenedor.innerHTML = '<div class="empty-search"><h3>No se encontraron pel√≠culas</h3><p>Intenta con otro t√©rmino de b√∫squeda</p></div>';
        return;
      }
      
      listaPeliculas.forEach(pelicula => {
        const peliculaElement = document.createElement("div");
        peliculaElement.className = "pelicula";
        peliculaElement.innerHTML = `
          <img src="${pelicula.imagen}" alt="${pelicula.titulo}">
          <div class="pelicula-info">
            <h3>${pelicula.titulo}</h3>
            <p>${pelicula.descripcion}</p>
            <button onclick="verPelicula('${pelicula.url}')">Ver Pel√≠cula</button>
          </div>
        `;
        contenedor.appendChild(peliculaElement);
      });
    }
    
    // Funci√≥n para filtrar pel√≠culas
    function filtrarPeliculas() {
      const busqueda = document.getElementById("buscador").value.toLowerCase();
      const peliculasFiltradas = peliculas.filter(pelicula => 
        pelicula.titulo.toLowerCase().includes(busqueda) || 
        pelicula.descripcion.toLowerCase().includes(busqueda)
      );
      cargarPeliculas(peliculasFiltradas);
    }
    
    // Detectar cuando esta ventana recupera el foco
    window.addEventListener('focus', function() {
      // Si tenemos una ventana de pel√≠cula abierta, verificamos si est√° cerrada
      if (peliculaVentana && peliculaVentana.closed) {
        pausarTemporizador();
        peliculaVentana = null;
      }
    });
    
    // Funci√≥n para mostrar notificaci√≥n
    function mostrarNotificacion(mensaje) {
      const notification = document.getElementById("notification");
      notification.textContent = mensaje;
      notification.style.display = "block";
      
      // Ocultar la notificaci√≥n despu√©s de 5 segundos
      setTimeout(() => {
        notification.style.display = "none";
      }, 5000);
    }
    
    // Funci√≥n para verificar si hay un temporizador activo al cargar la p√°gina
    function verificarTemporizadorActivo() {
      const temporizadorData = localStorage.getItem("temporizadorData");
      
      if (temporizadorData) {
        const data = JSON.parse(temporizadorData);
        
        // Verificar si el temporizador estaba pausado
        if (data.pausado) {
          document.getElementById("contador").textContent = "Temporizador pausado. Ver pel√≠cula para continuar.";
          return;
        }
        
        const tiempoTranscurrido = Date.now() - data.inicio;
        const tiempoRestante = tiempoMax - tiempoTranscurrido;
        
        // Si a√∫n queda tiempo, reiniciar el temporizador
        if (tiempoRestante > 0) {
          iniciarTemporizador(tiempoRestante);
        } else {
          // Si ya se complet√≥ el tiempo, registrar la ganancia
          registrarGanancia();
          localStorage.removeItem("temporizadorData");
          document.getElementById("contador").textContent = "Tiempo finalizado. ¬°Ganancia registrada!";
        }
      }
    }
    
    // Funci√≥n para iniciar la visualizaci√≥n de una pel√≠cula
    function verPelicula(url) {
      // Si hay un temporizador pausado, restaurar desde donde se qued√≥
      const temporizadorData = localStorage.getItem("temporizadorData");
      let tiempoRestante = tiempoMax;
      
      if (temporizadorData) {
        const data = JSON.parse(temporizadorData);
        if (data.pausado && data.tiempoRestante) {
          tiempoRestante = data.tiempoRestante;
        }
      }
      
      // Guardar datos del temporizador
      const inicioTiempo = Date.now();
      localStorage.setItem("temporizadorData", JSON.stringify({
        inicio: inicioTiempo,
        url: url,
        pausado: false,
        tiempoRestante: tiempoRestante
      }));
      
      // Abrir la pel√≠cula en una nueva pesta√±a y guardar referencia
      peliculaVentana = window.open(url, "_blank");
      
      // Verificar peri√≥dicamente si la ventana est√° cerrada
      const checkWindowInterval = setInterval(() => {
        if (peliculaVentana && peliculaVentana.closed) {
          clearInterval(checkWindowInterval);
          pausarTemporizador();
          peliculaVentana = null;
        }
      }, 1000);
      
      // Iniciar el temporizador
      contadorPausado = false;
      iniciarTemporizador(tiempoRestante);
    }
    
    // Funci√≥n para pausar el temporizador
    function pausarTemporizador() {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      
      contadorPausado = true;
      document.getElementById("contador").textContent = "Temporizador pausado. Ver pel√≠cula para continuar.";
      
      // Actualizar el estado en localStorage
      const temporizadorData = localStorage.getItem("temporizadorData");
      if (temporizadorData) {
        const data = JSON.parse(temporizadorData);
        // Calcular tiempo restante
        const tiempoTranscurrido = Date.now() - data.inicio;
        const tiempoRestante = tiempoMax - tiempoTranscurrido;
        
        // Guardar el tiempo restante y marcar como pausado
        localStorage.setItem("temporizadorData", JSON.stringify({
          ...data,
          pausado: true,
          tiempoRestante: tiempoRestante > 0 ? tiempoRestante : 0
        }));
      }
    }
    
    // Funci√≥n para iniciar el temporizador con la duraci√≥n especificada
    function iniciarTemporizador(duracion) {
      let restante = duracion;
      const display = document.getElementById("contador");
      clearInterval(timer); // Limpiar cualquier temporizador existente
      
      timer = setInterval(() => {
        // Si el contador est√° pausado, no continuar
        if (contadorPausado) {
          clearInterval(timer);
          timer = null;
          return;
        }
        
        restante -= 1000;
        
        if (restante <= 0) {
          clearInterval(timer);
          localStorage.removeItem("temporizadorData");
          display.textContent = "Tiempo finalizado. ¬°Ganancia registrada!";
          registrarGanancia();
          return;
        }
        
        const minutos = Math.floor(restante / 60000);
        const segundos = Math.floor((restante % 60000) / 1000);
        display.textContent = `Tiempo restante: ${minutos}m ${segundos}s`;
      }, 1000);
    }
    
    // Funci√≥n para registrar la ganancia cuando se completa el tiempo
    async function registrarGanancia() {
      try {
        if (!userId) {
          console.error("ID de usuario no disponible");
          return;
        }
        
        // Obtener saldo actual
        const { data, error: balanceError } = await supabase
          .from("users")
          .select("balance")
          .eq("id", userId)
          .single();
        
        if (balanceError || !data) {
          console.error("Error al obtener saldo:", balanceError);
          return;
        }
        
        // Calcular el nuevo saldo (agregar 0.5 por ver un video completo y 0.003 de recompensa adicional)
        const nuevoSaldo = parseFloat(data.balance) + 0.0 + 0.003;
        const saldoFormateado = formatearSaldo(nuevoSaldo);
        
        // Actualizar el saldo en la base de datos
        const { error: updateError } = await supabase
          .from("users")
          .update({ balance: nuevoSaldo })
          .eq("id", userId);
        
        if (updateError) {
          console.error("Error al actualizar saldo:", updateError);
        } else {
          // Actualizar el saldo en la interfaz
          document.getElementById("saldo").textContent = saldoFormateado;
          
          // Mostrar notificaci√≥n de recompensa exitosa
          mostrarNotificacion("¬°Recompensa exitosa! Se ha a√±adido 0.003 a tu saldo.");
        }
      } catch (error) {
        console.error("Error al registrar ganancia:", error);
      }
    }
    
    // Funci√≥n para ir al dashboard
    function irAlDashboard() {
      window.location.href = "dashboard.html";
    }
    
    // Funci√≥n para cerrar sesi√≥n
    async function cerrarSesion() {
      // Limpiar temporizador y datos locales
      clearInterval(timer);
      localStorage.removeItem("temporizadorData");
      
      // Cerrar sesi√≥n en Supabase
      const { error } = await supabase.auth.signOut();
      
      if (error) {
        console.error("Error al cerrar sesi√≥n:", error);
      } else {
        window.location.href = "login.html";
      }
    }
  </script>
</body>
</html>
