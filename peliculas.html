<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Películas con Temporizador</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #e50914;
      --dark-bg: #141414;
      --header-bg: #0c0c0c;
      --text-color: #fff;
      --secondary-bg: #222;
      --hover-color: #e50914;
      --highlight-bg: rgba(255, 255, 255, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--dark-bg);
      color: var(--text-color);
      padding: 0;
      margin: 0;
      line-height: 1.5;
    }
    
    header {
      background-color: var(--header-bg);
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .logo {
      color: var(--primary-color);
      font-size: 1.8rem;
      font-weight: bold;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }
    
    .user-info {
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 8px;
      margin: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .user-data {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .user-balance {
      font-size: 1.1rem;
      font-weight: bold;
      color: #4BB543;
    }
    
    #contador {
      font-size: 1.1rem;
      margin: 15px;
      padding: 12px;
      background: rgba(229, 9, 20, 0.2);
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
      color: #fff;
      text-align: center;
      font-weight: bold;
    }
    
    .instructions-banner {
      background: linear-gradient(to right, #1a237e, #283593);
      color: white;
      padding: 15px;
      margin: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
      border-left: 4px solid #3949ab;
    }
    
    .instructions-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .instructions-content {
      font-size: 0.95rem;
      line-height: 1.5;
    }
    
    .instructions-point {
      display: flex;
      align-items: flex-start;
      margin: 8px 0;
      gap: 8px;
    }
    
    .instructions-point i {
      margin-top: 3px;
      flex-shrink: 0;
    }
    
    .warning-banner {
      background: linear-gradient(to right, #ff8a00, #e52e71);
      color: white;
      padding: 15px;
      margin: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }
    
    .warning-icon {
      font-size: 1.5rem;
      margin-bottom: 8px;
      display: block;
      text-align: center;
    }
    
    .warning-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 12px;
      text-align: center;
    }
    
    .ad-banner {
      margin: 15px;
      text-align: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .button-container {
      display: flex;
      gap: 8px;
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
      margin-top: 0.5rem;
      width: 100%;
    }
    
    .dashboard-btn, .logout-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      flex: 1;
      font-size: 0.9rem;
    }
    
    .dashboard-btn {
      background-color: var(--primary-color);
      color: white;
    }
    
    .dashboard-btn:hover {
      background-color: #f40612;
    }
    
    .logout-btn {
      background-color: rgba(255,255,255,0.2);
      color: white;
    }
    
    .logout-btn:hover {
      background-color: rgba(255,255,255,0.3);
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background: rgba(75, 181, 67, 0.9);
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      animation: slideIn 0.5s forwards;
      font-size: 0.9rem;
      max-width: 90%;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .search-container {
      margin: 15px;
      position: relative;
    }
    
    .search-container input {
      width: 100%;
      padding: 10px 15px 10px 35px;
      border-radius: 30px;
      border: none;
      background-color: var(--secondary-bg);
      color: var(--text-color);
      font-size: 0.95rem;
    }
    
    .search-container i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,0.5);
    }
    
    .peliculas-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      padding: 15px;
    }
    
    .pelicula {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.3s, box-shadow 0.3s;
      display: flex;
      flex-direction: column;
      height: 100%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .pelicula:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    
    .pelicula img {
      width: 100%;
      height: auto;
      aspect-ratio: 2/3;
      object-fit: cover;
      transition: opacity 0.3s;
    }
    
    .pelicula:hover img {
      opacity: 0.8;
    }
    
    .pelicula-info {
      padding: 12px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    
    .pelicula h3 {
      margin: 0 0 8px;
      font-size: 1.1rem;
      font-weight: 700;
    }
    
    .pelicula p {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 12px;
      flex-grow: 1;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .pelicula button {
      padding: 10px;
      border: none;
      border-radius: 5px;
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.95rem;
      transition: background-color 0.3s;
      margin-top: auto;
    }
    
    .pelicula button:hover {
      background-color: #f40612;
    }
    
    .check-item {
      display: flex;
      align-items: flex-start;
      margin: 6px 0;
      gap: 8px;
    }
    
    .check-item i {
      color: #4BB543;
      margin-top: 5px;
      flex-shrink: 0;
    }
    
    .disclaimer {
      font-style: italic;
      color: rgba(255,255,255,0.7);
      margin-top: 10px;
      font-size: 0.85rem;
    }
    
    .empty-search {
      text-align: center;
      padding: 30px;
      grid-column: 1 / -1;
    }
    
    .bottom-ad {
      margin-top: 30px;
      margin-bottom: 30px;
      padding: 15px;
      text-align: center;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
      margin-left: 15px;
      margin-right: 15px;
    }
    
    /* Media queries para adaptación móvil */
    @media (min-width: 768px) {
      header {
        padding: 1rem 2rem;
        flex-wrap: nowrap;
      }
      
      .logo {
        margin-bottom: 0;
        font-size: 2rem;
      }
      
      .header-buttons {
        width: auto;
        margin-top: 0;
      }
      
      .user-data {
        flex-direction: row;
        justify-content: space-between;
      }
      
      .pelicula img {
        height: 380px;
      }
      
      .pelicula p {
        -webkit-line-clamp: 5;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">MovieFlix</div>
    <div class="header-buttons">
      <button class="dashboard-btn" onclick="irAlDashboard()">Dashboard</button>
      <button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesión</button>
    </div>
  </header>
  
  <div class="user-info">
    <div class="user-data">
      <div>
        <p>Correo: <span id="email">Cargando...</span></p>
      </div>
      <div class="user-balance">
        <p>Saldo: S/ <span id="saldo">Cargando...</span></p>
      </div>
    </div>
  </div>
  
  <!-- Nuevo banner de instrucciones -->
  <div class="instructions-banner">
    <div class="instructions-title">
      <i class="fas fa-film"></i>
      <span>🎬 Antes de ver la película, por favor lee esto:</span>
    </div>
    <div class="instructions-content">
      <p>Para mantener esta plataforma gratuita y al mismo tiempo poder recompensarte por tu tiempo, <strong>verás varios anuncios emergentes (pop-ups)</strong> antes de que comience cada película.</p>
      
      <div class="instructions-point">
        <i class="fas fa-desktop"></i>
        <span><strong>Si estás en PC:</strong> Se abrirán nuevas pestañas con publicidad. <strong>Solo ciérralas</strong> y quédate en la pestaña original donde está el reproductor.</span>
      </div>
      
      <div class="instructions-point">
        <i class="fas fa-mobile-alt"></i>
        <span><strong>Si estás en celular:</strong> Es posible que el navegador te redireccione. <strong>Solo presiona el botón "atrás"</strong> hasta volver al reproductor.</span>
      </div>
      
      <div class="instructions-point">
        <i class="fas fa-dollar-sign"></i>
        <span><strong>Importante:</strong> Por cada película vista de principio a fin, recibirás <strong>$0.003</strong> acreditados en tu cuenta.</span>
      </div>
      
      <div class="instructions-point">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Los anuncios aparecen <strong>solo al inicio</strong>. Una vez comience la película, <strong>no habrá más interrupciones</strong>.</span>
      </div>
      
      <p>Gracias por tu tiempo y apoyo. ¡Disfruta la película y empieza a ganar! 🍿💵</p>
    </div>
  </div>
  
  <!-- Banner de anuncios superior -->
  <div class="ad-banner">
    <script type="text/javascript">
      atOptions = {
        'key' : 'b330ccd204185aee9ef640adccf896d2',
        'format' : 'iframe',
        'height' : 90,
        'width' : 728,
        'params' : {}
      };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/b330ccd204185aee9ef640adccf896d2/invoke.js"></script>
  </div>
  
  <div class="warning-banner">
    <span class="warning-icon">⚠️</span>
    <h3 class="warning-title">¡Advertencia! Estás a punto de ganar dinero viendo una película 🍿💸</h3>
    <p>Sí, leíste bien. Cada vez que ves una película en esta plataforma con anuncios, <strong>se genera ingreso</strong>… 🫢 <em>¿Y sabes quién gana más que nosotros?</em> 👉 ¡<strong>Tú!</strong></p>
    <div style="margin-top: 15px;">
      <div class="check-item">
        <i class="fas fa-check-circle"></i>
        <span>Porque no pagas ni un dolar.</span>
      </div>
      <div class="check-item">
        <i class="fas fa-check-circle"></i>
        <span>Porque accedes a películas completas sin restricciones.</span>
      </div>
      <div class="check-item">
        <i class="fas fa-check-circle"></i>
        <span>Porque solo con mirar, <strong>generas ingresos que hacen posible este sitio</strong>.</span>
      </div>
      <div class="check-item">
        <i class="fas fa-check-circle"></i>
        <span>Porque si todos saltaran los anuncios, <strong>no existiría esta página</strong>.</span>
      </div>
    </div>
    <p class="disclaimer">🔐 Si eliges el modo sin anuncios, tendrás acceso limitado. Pero si ves con anuncios, <strong>tú estás financiando tu propio entretenimiento</strong>. <em>¿Quién más te paga por mirar pelis?</em></p>
  </div>
  
  <div id="notification" class="notification">¡Recompensa exitosa! Se ha añadido 0.003 a tu saldo.</div>
  
  <p id="contador">Tiempo restante: --</p>
  
  <div class="search-container">
    <i class="fas fa-search"></i>
    <input type="text" id="buscador" placeholder="Buscar películas..." oninput="filtrarPeliculas()">
  </div>
  
  <div id="peliculas-container" class="peliculas-container">
    <!-- Las películas se generarán dinámicamente -->
  </div>
  
  <!-- Banner de anuncios lateral -->
  <div class="ad-banner">
    <script type="text/javascript">
      atOptions = {
        'key' : 'a55c7cdc78df0520f71c2b00e4046167',
        'format' : 'iframe',
        'height' : 300,
        'width' : 160,
        'params' : {}
      };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/a55c7cdc78df0520f71c2b00e4046167/invoke.js"></script>
  </div>
  
  <!-- Banner de anuncios inferior -->
  <div class="bottom-ad">
    <script async="async" data-cfasync="false" src="//pl26063295.profitableratecpm.com/2537ae2ea8b16bc9e554273a94dfd098/invoke.js"></script>
    <div id="container-2537ae2ea8b16bc9e554273a94dfd098"></div>
  </div>
  
  <script>
    // Configuración de Supabase con tus credenciales
    const SUPABASE_URL = "https://srormesvqserhrfugrls.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyb3JtZXN2cXNlcmhyZnVncmxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMzNTk0MzUsImV4cCI6MjA1ODkzNTQzNX0.zGjT9CbTd6jb1lEBzK3OrsZJIgZSqJH9zfLXzWvLTlM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Lista de películas
    const peliculas = [
      {
        id: 1,
        titulo: "Bajo custodia",
        imagen: "https://pics.filmaffinity.com/Bajo_custodia-198204017-large.jpg",
        descripcion: "Una mujer enigmática despierta dentro de una comisaría abandonada en medio de la noche sin recordar cómo llegó allí. Dos detectives intentan reconstruir sus pasos para acusarla de un atropello.",
        url: "https://do7go.com/e/utfh2cbr2q7a"
      },
     
     {
        id: 4,
        titulo: "Mufasa: El rey león",
        imagen: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT3qgJGo_kuxKI1WfyJm9MpD1_HF4Ngo9TaUBR-rdeAgVUEV83x",
        descripcion: "Una inundación separa al cachorro Mufasa de sus padres, pero el rey de los leones lo acoge como a uno de los suyos tras demostrar su valentía. Al crecer, una manada de leones desterrados y los celos de su hermana adoptiva lo pondrán en peligro.",
        url: "https://do7go.com/e/q3lh2jn8xgr7"
      },
      {
        id: 4,
        titulo: "Compañera perfecta",
        imagen: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSERdDje5LXVuY3jrLwwGOWLOOse_G8LkjXwvh1Ar0atZ_h7rZE",
        descripcion: "Un grupo de amigos va a pasar el fin de semana a la finca de un excéntrico millonario, novio de una de ellos. Allí una de las chicas asesina al dueño de la mansión para evitar que la viole, pero, entonces, descubre que nada es lo que parece.",
        url: "https://do7go.com/d/lgda3wy72smj"
      },
      {
        id: 4,
        titulo: "El río de la muerte",
        imagen: "https://m.media-amazon.com/images/M/MV5BNmY3NGRkZjItZjQzZS00NjQ2LTlhYmYtNGJiNDQ0M2VjZGRjXkEyXkFqcGc@._V1_QL75_UY281_CR5,0,190,281_.jpg",
        descripcion: "Dos parejas de amigos deciden realizar un recorrido en kayak por la selva. Pero, sin saberlo, el grupo se adentra en el peligroso territorio de una tribu indígena de caníbales despiadados conocida por sus horripilantes rituales.",
        url: "https://do7go.com/e/7ww27e1druzw"
      },
      {
        id: 4,
        titulo: "Contrabando",
        imagen: "https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcRVQ3JPc-9NgZjdk3zBbwfIGENF2nQtvsHV19yRUGZk3nT3ETNK",
        descripcion: "El excontrabanidta Chris Farraday dejó el crimen años atrás, pero se ve obligado a regresar al juego luego de que su cuñado, Andy, le falla a un narcotraficante durante un negocio de drogas, provocando una gran deuda. Con la ayuda de su mejor amigo, Chris reúne a un equipo para viajar a Panamá y recuperar una fortuna en billetes falsos. Cuando las cosas fallan, Chris debe usar sus habilidades para completar la tarea.",
        url: "https://do7go.com/e/dxd9dox6tido"
      },
    ];
    
    const tiempoMax = 90 * 60 * 1000; // 1 hora 30 min en milisegundos
    let timer = null;
    let userId = null;
    let peliculaVentana = null;
    let contadorPausado = false;
    
    // Función para formatear un número a 3 decimales
    function formatearSaldo(saldo) {
      return parseFloat(saldo).toFixed(3);
    }
    
    // Función para cargar los datos del usuario
    document.addEventListener("DOMContentLoaded", async () => {
      // Verificar autenticación
      const { data: { user }, error } = await supabase.auth.getUser();
      
      if (error || !user) {
        alert("No has iniciado sesión");
        window.location.href = "login.html";
        return;
      }
      
      // Guardar ID del usuario para uso posterior
      userId = user.id;
      
      // Mostrar email del usuario
      document.getElementById("email").textContent = user.email;
      
      // Obtener saldo
      const { data, error: balanceError } = await supabase
        .from("users")
        .select("balance")
        .eq("id", user.id)
        .single();
      
      if (balanceError || !data) {
        document.getElementById("saldo").textContent = "0.000";
      } else {
        document.getElementById("saldo").textContent = formatearSaldo(data.balance);
      }
      
      // Cargar películas
      cargarPeliculas(peliculas);
      
      // Verificar si hay un temporizador activo
      verificarTemporizadorActivo();
      
      // Ajustar banners de anuncios en móviles
      adjustAdsForMobile();
    });
    
    // Función para ajustar anuncios en móviles
    function adjustAdsForMobile() {
      if (window.innerWidth < 768) {
        const adBanners = document.querySelectorAll('.ad-banner');
        adBanners.forEach(banner => {
          const scripts = banner.querySelectorAll('script');
          if (scripts.length > 0) {
            const scriptContent = scripts[0].innerHTML;
            if (scriptContent.includes('width') && scriptContent.includes('height')) {
              const newScript = document.createElement('script');
              newScript.type = 'text/javascript';
              newScript.innerHTML = scriptContent.replace(/width'\s*:\s*\d+/, "width' : " + Math.min(300, window.innerWidth - 40));
              scripts[0].parentNode.replaceChild(newScript, scripts[0]);
            }
          }
        });
      }
    }
    
    // Función para cargar películas
    function cargarPeliculas(listaPeliculas) {
      const contenedor = document.getElementById("peliculas-container");
      contenedor.innerHTML = "";
      
      if (listaPeliculas.length === 0) {
        contenedor.innerHTML = '<div class="empty-search"><h3>No se encontraron películas</h3><p>Intenta con otro término de búsqueda</p></div>';
        return;
      }
      
      listaPeliculas.forEach(pelicula => {
        const peliculaElement = document.createElement("div");
        peliculaElement.className = "pelicula";
        peliculaElement.innerHTML = `
          <img src="${pelicula.imagen}" alt="${pelicula.titulo}" loading="lazy">
          <div class="pelicula-info">
            <h3>${pelicula.titulo}</h3>
            <p>${pelicula.descripcion}</p>
            <button onclick="verPelicula('${pelicula.url}')">Ver Película</button>
          </div>
        `;
        contenedor.appendChild(peliculaElement);
      });
    }
    
    // Función para filtrar películas
    function filtrarPeliculas() {
      const busqueda = document.getElementById("buscador").value.toLowerCase();
      const peliculasFiltradas = peliculas.filter(pelicula => 
        pelicula.titulo.toLowerCase().includes(busqueda) || 
        pelicula.descripcion.toLowerCase().includes(busqueda)
      );
      cargarPeliculas(peliculasFiltradas);
    }
    
    // Detectar cuando esta ventana recupera el foco
    window.addEventListener('focus', function() {
      // Si tenemos una ventana de película abierta, verificamos si está cerrada
      if (peliculaVentana && peliculaVentana.closed) {
        pausarTemporizador();
        peliculaVentana = null;
      }
    });
    
    // Función para mostrar notificación
    function mostrarNotificacion(mensaje) {
      const notification = document.getElementById("notification");
      notification.textContent = mensaje;
      notification.style.display = "block";
      
      // Ocultar la notificación después de 5 segundos
      setTimeout(() => {
        notification.style.display = "none";
      }, 5000);
    }
    
    // Función para verificar si hay un temporizador activo al cargar la página
    function verificarTemporizadorActivo() {
      const temporizadorData = localStorage.getItem("temporizadorData");
      
      if (temporizadorData) {
        const data = JSON.parse(temporizadorData);
        
        // Verificar si el temporizador estaba pausado
        if (data.pausado) {
          document.getElementById("contador").textContent = "Temporizador pausado. Ver película para continuar.";
          return;
        }
        
        const tiempoTranscurrido = Date.now() - data.inicio;
        const tiempoRestante = tiempoMax - tiempoTranscurrido;
        
        // Si aún queda tiempo, reiniciar el temporizador
        if (tiempoRestante > 0) {
          iniciarTemporizador(tiempoRestante);
        } else {
          // Si ya se completó el tiempo, registrar la ganancia
          registrarGanancia();
          localStorage.removeItem("temporizadorData");
          document.getElementById("contador").textContent = "Tiempo finalizado. ¡Ganancia registrada!";
        }
      } else {
        document.getElementById("contador").textContent = "Selecciona una película para iniciar el temporizador";
      }
    }
    
    // Función para iniciar el temporizador
function iniciarTemporizador(duracion = tiempoMax) {
  clearInterval(timer);
  contadorPausado = false;
  
  const inicio = Date.now();
  const finalizacion = inicio + duracion;
  
  // Guardar datos del temporizador en localStorage
  localStorage.setItem("temporizadorData", JSON.stringify({
    inicio: inicio,
    duracion: duracion,
    pausado: false
  }));
  
  timer = setInterval(() => {
    const ahora = Date.now();
    const tiempoRestante = finalizacion - ahora;
    
    if (tiempoRestante <= 0) {
      clearInterval(timer);
      document.getElementById("contador").textContent = "¡Tiempo completado! Registrando ganancia...";
      registrarGanancia();
      localStorage.removeItem("temporizadorData");
    } else {
      // Formatear tiempo restante
      const minutos = Math.floor(tiempoRestante / 60000);
      const segundos = Math.floor((tiempoRestante % 60000) / 1000);
      document.getElementById("contador").textContent = 
        `Tiempo restante: ${minutos}:${segundos < 10 ? '0' : ''}${segundos}`;
    }
  }, 1000);
}

// Función para pausar el temporizador
function pausarTemporizador() {
  if (timer) {
    clearInterval(timer);
    const temporizadorData = JSON.parse(localStorage.getItem("temporizadorData"));
    
    if (temporizadorData) {
      const tiempoTranscurrido = Date.now() - temporizadorData.inicio;
      const tiempoRestante = temporizadorData.duracion - tiempoTranscurrido;
      
      // Guardar datos del temporizador pausado
      localStorage.setItem("temporizadorData", JSON.stringify({
        inicio: Date.now(),
        duracion: tiempoRestante,
        pausado: true
      }));
      
      contadorPausado = true;
      document.getElementById("contador").textContent = "Temporizador pausado. Ver película para continuar.";
    }
  }
}

// Función para registrar la ganancia después de ver la película
async function registrarGanancia() {
  if (!userId) return;
  
  try {
    // Obtener saldo actual
    const { data: userData, error: userError } = await supabase
      .from("users")
      .select("balance")
      .eq("id", userId)
      .single();
    
    if (userError) throw userError;
    
    // Valor de la recompensa
    const recompensa = 0.003;
    
    // Actualizar saldo
    const nuevoSaldo = parseFloat(userData.balance) + recompensa;
    
    const { error: updateError } = await supabase
      .from("users")
      .update({ balance: nuevoSaldo })
      .eq("id", userId);
    
    if (updateError) throw updateError;
    
    // Mostrar notificación y actualizar saldo en la página
    mostrarNotificacion(`¡Recompensa exitosa! Se ha añadido ${recompensa.toFixed(3)} a tu saldo.`);
    document.getElementById("saldo").textContent = formatearSaldo(nuevoSaldo);
    
    // Registrar la transacción
    const { error: transError } = await supabase
      .from("transactions")
      .insert({
        user_id: userId,
        amount: recompensa,
        type: "reward",
        description: "Recompensa por ver película"
      });
    
    if (transError) console.error("Error al registrar transacción:", transError);
    
  } catch (error) {
    console.error("Error al registrar ganancia:", error);
    mostrarNotificacion("Hubo un error al procesar tu recompensa. Inténtalo de nuevo.");
  }
}

// Función para ver película
function verPelicula(url) {
  // Abrir película en nueva ventana/pestaña
  peliculaVentana = window.open(url, "_blank");
  
  // Iniciar o reanudar el temporizador
  const temporizadorData = localStorage.getItem("temporizadorData");
  
  if (temporizadorData) {
    const data = JSON.parse(temporizadorData);
    
    if (data.pausado) {
      // Reanudar temporizador pausado
      iniciarTemporizador(data.duracion);
    }
  } else {
    // Iniciar nuevo temporizador
    iniciarTemporizador();
  }
}

// Función para ir al dashboard
function irAlDashboard() {
  window.location.href = "dashboard.html";
}

// Función para cerrar sesión
async function cerrarSesion() {
  if (timer) {
    pausarTemporizador();
  }
  
  const { error } = await supabase.auth.signOut();
  if (error) {
    console.error("Error al cerrar sesión:", error);
    return;
  }
  
  window.location.href = "login.html";
}

// Manejar visibilidad de la página
document.addEventListener("visibilitychange", function() {
  if (document.visibilityState === "hidden" && timer && !contadorPausado) {
    pausarTemporizador();
  }
});

// Ajustar para dispositivos móbiles en cambio de orientación
window.addEventListener("resize", adjustAdsForMobile);
