<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Películas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f0f0f0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .user-info {
      text-align: right;
    }
    .movie-container {
      display: flex;
      flex-direction: column;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .movie-info {
      display: flex;
      padding: 20px;
    }
    .movie-poster {
      width: 200px;
      height: 300px;
      object-fit: cover;
      margin-right: 20px;
      border-radius: 4px;
    }
    .movie-details {
      flex: 1;
    }
    .player-container {
      width: 100%;
      padding: 20px;
      text-align: center;
      display: none;
    }
    .player-container iframe {
      max-width: 100%;
      border-radius: 8px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .earn-button {
      background-color: #ff9800;
    }
    .earn-button:hover {
      background-color: #e88e00;
    }
    h2, h3 {
      margin-top: 0;
    }
    .movies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .movie-card {
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .movie-card:hover {
      transform: translateY(-5px);
    }
    .movie-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .movie-card-info {
      padding: 15px;
    }
    .movie-card h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    .movie-card p {
      margin: 5px 0;
      font-size: 14px;
      color: #666;
    }
    .back-button {
      background-color: #2196F3;
      margin-bottom: 20px;
    }
    .back-button:hover {
      background-color: #0b7dda;
    }
    .timer-container {
      margin-top: 15px;
      font-size: 16px;
    }
    .timer {
      font-weight: bold;
      color: #e91e63;
    }
    .blocked-message {
      color: #e91e63;
      font-weight: bold;
      margin-top: 10px;
      display: none;
    }
  </style>
  <script>
    const SUPABASE_URL = "https://srormesvqserhrfugrls.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyb3JtZXN2cXNlcmhyZnVncmxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMzNTk0MzUsImV4cCI6MjA1ODkzNTQzNX0.zGjT9CbTd6jb1lEBzK3OrsZJIgZSqJH9zfLXzWvLTlM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Películas data
    const peliculas = [
      {
        titulo: "I.S.S.",
        imagen: "https://www.cuevana.is/_next/image?url=https%3A%2F%2Fimage.tmdb.org%2Ft%2Fp%2Foriginal%2F2ZgXNi458jc7DqdAMhsHpF1sX0I.jpg&w=640&q=75",
        url: "", // URL está vacía
        sinopsis: "Cuando se produce un acontecimiento bélico mundial en la Tierra, Estados Unidos y Rusia, ambas naciones contactan en secreto con sus astronautas a bordo de la ISS y les dan instrucciones para que tomen el control de la estación por cualquier medio necesario.",
        genero: "Ciencia ficción, Suspenso",
        actores: "Ariana DeBose, Chris Messina, John Gallagher Jr., Мария Машкова, Costa Ronin, Pilou Asbæk, Mohamed ElGohary, Dean Labossiere, K.C. White, Tanya Giang, Jimmie Lee Sessoms",
        anio: "2024"
      },
      {
        titulo: "Bajo custodia",
        imagen: "https://pics.filmaffinity.com/Bajo_custodia-198204017-large.jpg",
        url: "https://mega.nz/file/UtxyVSiD#aKDB0n0uIYYZmyjSPmlECZPFaPCQ7mzyhNC64X50vqA",
        sinopsis: "Una mujer enigmática despierta dentro de una comisaría abandonada en medio de la noche sin recordar cómo llegó allí. Dos detectives intentan reconstruir sus pasos para acusarla de un atropello.",
        genero: "Thriller, Drama",
        actores: "Actores no disponibles",
        anio: "2024"
      },
      {
        titulo: "Equipaje de mano",
        imagen: "https://images.justwatch.com/poster/322836177/s166/equipaje-de-mano-2024.avif",
        url: "https://mega.nz/file/g1JVhJIa#blYnA6tfvZfuMvuOk66dwTb9X-aSSmwARAMHrMfV7e8",
        sinopsis: "El día de Nochebuena, en el concurrido aeropuerto de Los Angeles, un desconocido chantajea a un joven agente de la Administración de Seguridad en el Transporte, encargado de escanear el equipaje de mano, para que le deje subir una misteriosa maleta al avión.",
        genero: "Thriller, Acción",
        actores: "Actores no disponibles",
        anio: "2024"
      },
      {
        titulo: "Fuego Cruzado",
        imagen: "https://m.media-amazon.com/images/M/MV5BMTY2NDc0MjMtMzk4Ny00MWE0LWE2OTgtZDQ0NDBjMjQ3MjJjXkEyXkFqcGc@._V1_.jpg",
        url: "https://mega.nz/file/dhByQCLb#41SIXG3FKwwfrN83sQfZnL6P1Qj6YJtGhGkE4y_oE3Q",
        sinopsis: "Un criminal reúne un ejército de reclusos y se enfrenta a un ex agente.",
        genero: "Acción",
        actores: "Actores no disponibles",
        anio: "2024"
      },
      {
        titulo: "Rápidos y Furiosos X",
        imagen: "https://www.infobae.com/resizer/v2/VW6GWH7SPFG67A4SJP3E7KVBTI.jpeg?auth=00b9e92b0e19b1b6a90457f56bd4d649bb01b3a3ff7f2e0c89a996ada89d7dba&smart=true&width=350&height=467&quality=85",
        url: "https://mega.nz/file/J0oHnbjK#WckEcI4mpevkBP045gGqSdy3R4lqTxNNPrBVgVeSniU",
        sinopsis: "En la décima entrega de la saga Rápidos y Furiosos, Toretto y su familia desafían todas las leyes de la física en una lucha motorizada contra Dante Reyes (Jason Momoa), un vengativo adversario que emerge de las sombras del pasado.",
        genero: "Acción, Aventura",
        actores: "Vin Diesel, Jason Momoa, Michelle Rodriguez, Jason Statham",
        anio: "2023"
      },
      {
        titulo: "Respira",
        imagen: "https://pics.filmaffinity.com/Respira-938032787-large.jpg",
        url: "https://mega.nz/file/tppm1IYB#knSjgtPDoVdsLqGSvZbnjhLFGnnCHvedooO264O7xmY",
        sinopsis: "Dos desconocidos amenazan a una madre y a su hija en una Tierra que quedó inhabitable por falta de oxígeno.",
        genero: "Ciencia ficción, Thriller",
        actores: "Actores no disponibles",
        anio: "2024"
      },
      {
        titulo: "Sonic 3 La Película",
        imagen: "https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcSu8nsDSE6dU7T3vTQShr0OgDHiCZSetzqGfkwV46_RphV-NogS",
        url: "",
        sinopsis: "Sonic, Knuckles y Tails regresan para vivir su aventura más épica. El equipo enfrenta a un poderoso enemigo, Shadow, un erizo misterioso con habilidades nunca antes vistas.",
        genero: "Animación, Aventura",
        actores: "Jim Carrey, James Marsden, Idris Elba, Ben Schwartz",
        anio: "2024"
      },
      {
        titulo: "Venom: El último baile",
        imagen: "https://tv8.cuevana3.vip/wp-content/uploads/venom-el-ultimo-baile-2024.jpg",
        url: "https://mega.nz/file/I8hlEYwK#Ro3GrGzAJS6L0jUOpUeGfEIA5GXD2GmD6a_i5ADG5kY",
        sinopsis: "Eddie y Venom están a la fuga. Perseguidos por sus sendos mundos y cada vez más cercados, el dúo se ve abocado a tomar una decisión devastadora que hará que caiga el telón sobre el último baile de Venom y Eddie.",
        genero: "Acción, Ciencia ficción",
        actores: "Tom Hardy, Juno Temple, Chiwetel Ejiofor",
        anio: "2024"
      },
      {
        titulo: "Winnie the Pooh: Sangre y miel",
        imagen: "https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcRKIMfNVHYaQkcZU4E2vmWCuX_sVl85MpJu_UG-20k4f6LmQOlj",
        url: "https://mega.nz/file/koxUAQDA#30SiGJAdEOgtM7S484AuyENFzMGb6pZ583Miu8BeAFc",
        sinopsis: "Winnie the Pooh y Piglet se han vuelto salvajes y quieren sangre humana. Los antes entrañables amigos aterrorizan a Christopher Robin y un grupo de jóvenes en una casa aislada.",
        genero: "Terror",
        actores: "Actores no disponibles",
        anio: "2023"
      },
      {
        titulo: "Depravación",
        imagen: "https://www.cuevana.is/_next/image?url=https%3A%2F%2Fimage.tmdb.org%2Ft%2Fp%2Foriginal%2FcC1mG3UAfITKUBHtwtD7xaNnX10.jpg&w=640&q=75",
        url: "https://mega.nz/file/I4RVUJJS#OCfqBGts3hddi_umTAw3BJCl53Zv_-aUyF-H4HHXQnU",
        sinopsis: "Cuando tres vecinos sospechan que su solitario vecino es un asesino en serie, irrumpen en su apartamento para descubrir una fortuna oculta en obras de arte robadas. Pero su descubrimiento se convierte en una pesadilla al verse atrapados en un sádico juego de supervivencia, donde cada esquina esconde un nuevo horror.",
        genero: "Terror, Thriller",
        actores: "Actores no disponibles",
        anio: "2024"
      }
    ];
    
    let currentMovie = null;
    let currentMovieIndex = -1;
    let watchingTimer = null;
    let isWatching = false;
    let watchStartTime = null;
    let movieWatchTime = 90 * 60 * 1000; // 1 hora y 30 minutos en milisegundos
    
    document.addEventListener("DOMContentLoaded", async function () {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        window.location.href = "login.html";
        return;
      }
      
      document.getElementById("user-email").textContent = user.email;
      const { data: userData } = await supabase
        .from("users")
        .select("balance, watch_state")
        .eq("id", user.id)
        .single();
      document.getElementById("user-balance").textContent = (userData.balance ?? 0).toFixed(3);
      
      // Verificar si hay una película en progreso
      if (userData.watch_state) {
        try {
          const watchState = JSON.parse(userData.watch_state);
          if (watchState.isWatching && watchState.startTime) {
            isWatching = true;
            watchStartTime = new Date(watchState.startTime);
            currentMovieIndex = watchState.movieIndex;
            if (currentMovieIndex >= 0 && currentMovieIndex < peliculas.length) {
              currentMovie = peliculas[currentMovieIndex];
              showMovieDetail(currentMovieIndex, true);
              return;
            }
          }
        } catch (e) {
          console.error("Error al parsear watch_state:", e);
        }
      }
      
      // Si no hay película activa, mostrar la lista
      showMoviesList();
    });
    
    function showMoviesList() {
      const container = document.getElementById("main-content");
      container.innerHTML = "";
      
      // Si hay una película en progreso, mostrar mensaje
      if (isWatching) {
        const blockedMessage = document.createElement("div");
        blockedMessage.className = "blocked-message";
        blockedMessage.style.display = "block";
        blockedMessage.innerHTML = `
          <p>Tienes una película en progreso. Debes terminar de verla y reclamar tu recompensa antes de ver otra película.</p>
          <button onclick="continueWatching(${currentMovieIndex})">Continuar viendo</button>
        `;
        container.appendChild(blockedMessage);
      }
      
      const moviesGrid = document.createElement("div");
      moviesGrid.className = "movies-grid";
      
      peliculas.forEach((pelicula, index) => {
        const movieCard = document.createElement("div");
        movieCard.className = "movie-card";
        movieCard.innerHTML = `
          <img src="${pelicula.imagen}" alt="${pelicula.titulo}" onerror="this.src='/api/placeholder/300/200'">
          <div class="movie-card-info">
            <h3>${pelicula.titulo}</h3>
            <p>${pelicula.genero}</p>
            <p>${pelicula.anio}</p>
          </div>
        `;
        movieCard.onclick = () => {
          if (isWatching && currentMovieIndex !== index) {
            alert("Ya estás viendo una película. Debes terminar de verla antes de ver otra.");
          } else {
            showMovieDetail(index);
          }
        };
        moviesGrid.appendChild(movieCard);
      });
      
      container.appendChild(moviesGrid);
    }
    
    function continueWatching(index) {
      showMovieDetail(index, true);
    }
    
    function showMovieDetail(index, resuming = false) {
      currentMovie = peliculas[index];
      currentMovieIndex = index;
      
      const container = document.getElementById("main-content");
      container.innerHTML = "";
      
      // Botón para volver a la lista
      const backButton = document.createElement("button");
      backButton.textContent = "← Volver a la lista";
      backButton.className = "back-button";
      backButton.onclick = showMoviesList;
      container.appendChild(backButton);
      
      // Contenedor de película
      const movieContainer = document.createElement("div");
      movieContainer.className = "movie-container";
      
      // Información de la película
      const movieInfo = document.createElement("div");
      movieInfo.className = "movie-info";
      
      // Poster
      const poster = document.createElement("img");
      poster.src = currentMovie.imagen;
      poster.alt = currentMovie.titulo;
      poster.className = "movie-poster";
      poster.onerror = function() { this.src = '/api/placeholder/200/300'; };
      movieInfo.appendChild(poster);
      
      // Detalles
      const details = document.createElement("div");
      details.className = "movie-details";
      details.innerHTML = `
        <h3>${currentMovie.titulo}</h3>
        <p><strong>Año:</strong> ${currentMovie.anio}</p>
        <p><strong>Género:</strong> ${currentMovie.genero}</p>
        <p><strong>Actores:</strong> ${currentMovie.actores}</p>
        <p><strong>Sinopsis:</strong> ${currentMovie.sinopsis}</p>
      `;
      
      // Botón para ver película
      const viewButton = document.createElement("button");
      viewButton.id = "ver-btn";
      
      if (!currentMovie.url) {
        viewButton.disabled = true;
        viewButton.textContent = "Película no disponible";
      } else if (resuming && isWatching) {
        viewButton.textContent = "Continuar viendo";
        viewButton.onclick = verPelicula;
      } else {
        viewButton.textContent = "Ver película";
        viewButton.onclick = verPelicula;
      }
      
      details.appendChild(viewButton);
      
      // Botón para ganar dinero
      const earnButton = document.createElement("button");
      earnButton.id = "ganar-btn";
      earnButton.textContent = "Ganar S/ 0.003";
      earnButton.className = "earn-button";
      earnButton.style.display = "none";
      earnButton.onclick = sumarBalancePeliculas;
      details.appendChild(earnButton);
      
      // Container para el timer
      const timerContainer = document.createElement("div");
      timerContainer.id = "timer-container";
      timerContainer.className = "timer-container";
      timerContainer.style.display = "none";
      timerContainer.innerHTML = `
        <p>Debes ver la película durante <span class="timer" id="timer">01:30:00</span> para recibir tu recompensa.</p>
      `;
      details.appendChild(timerContainer);
      
      movieInfo.appendChild(details);
      movieContainer.appendChild(movieInfo);
      
      // Contenedor del reproductor
      const playerContainer = document.createElement("div");
      playerContainer.id = "player-container";
      playerContainer.className = "player-container";
      
      // Verificar tipo de URL
      if (currentMovie.url && currentMovie.url.includes("mega.nz")) {
        // Para enlaces de MEGA, proporcionamos instrucciones
        playerContainer.innerHTML = `
          <div style="padding: 20px; text-align: center;">
            <h3>Esta película está alojada en MEGA</h3>
            <p>Haz clic en el siguiente enlace para verla:</p>
            <a href="${currentMovie.url}" target="_blank" style="color: #4CAF50; font-weight: bold;">${currentMovie.titulo} - Ver en MEGA</a>
            <p style="margin-top: 15px;">Debes ver la película completa (aproximadamente 1 hora y 30 minutos) para recibir tu recompensa.</p>
            <p>Por favor, no cierres esta ventana mientras ves la película.</p>
          </div>
        `;
      } else if (currentMovie.url && currentMovie.url.includes("streamtape.com")) {
        // Para enlaces de Streamtape, mostramos el reproductor embebido
        const videoId = currentMovie.url.split('/').pop();
        playerContainer.innerHTML = `
          <iframe src="https://streamtape.com/e/${videoId}/" width="800" height="500" allowfullscreen allowtransparency allow="autoplay" scrolling="no" frameborder="0"></iframe>
        `;
      } else if (currentMovie.url) {
        // Para otros enlaces, intentamos un iframe genérico
        playerContainer.innerHTML = `
          <iframe src="${currentMovie.url}" width="800" height="500" allowfullscreen frameborder="0"></iframe>
        `;
      }
      
      movieContainer.appendChild(playerContainer);
      container.appendChild(movieContainer);
      
      if (resuming && isWatching && watchStartTime) {
        // Mostrar el reproductor y actualizar la interfaz
        document.getElementById("player-container").style.display = "block";
        document.getElementById("ver-btn").textContent = "Película en reproducción";
        document.getElementById("ver-btn").disabled = true;
        document.getElementById("timer-container").style.display = "block";
        
        // Calcular el tiempo restante y continuar el temporizador
        const elapsedTime = new Date() - new Date(watchStartTime);
        const remainingTime = Math.max(0, movieWatchTime - elapsedTime);
        
        if (remainingTime <= 0) {
          // Si ya pasó el tiempo, mostrar el botón de recompensa
          document.getElementById("ganar-btn").style.display = "block";
          document.getElementById("timer").innerText = "00:00:00";
        } else {
          // Continuar el temporizador
          updateTimer(remainingTime);
          watchingTimer = setInterval(() => {
            const newElapsedTime = new Date() - new Date(watchStartTime);
            const newRemainingTime = Math.max(0, movieWatchTime - newElapsedTime);
            
            if (newRemainingTime <= 0) {
              clearInterval(watchingTimer);
              document.getElementById("ganar-btn").style.display = "block";
              document.getElementById("timer").innerText = "00:00:00";
            } else {
              updateTimer(newRemainingTime);
            }
          }, 1000);
        }
      }
    }
    
    function updateTimer(remainingTime) {
      const hours = Math.floor(remainingTime / (60 * 60 * 1000));
      const minutes = Math.floor((remainingTime % (60 * 60 * 1000)) / (60 * 1000));
      const seconds = Math.floor((remainingTime % (60 * 1000)) / 1000);
      
      document.getElementById("timer").innerText = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    async function verPelicula() {
      if (!currentMovie.url) return;
      
      const playerContainer = document.getElementById("player-container");
      const verBtn = document.getElementById("ver-btn");
      const timerContainer = document.getElementById("timer-container");
      
      playerContainer.style.display = "block";
      verBtn.textContent = "Película en reproducción";
      verBtn.disabled = true;
      timerContainer.style.display = "block";
      
      // Iniciar nuevo temporizador si no estamos reanudando
      if (!isWatching) {
        isWatching = true;
        watchStartTime = new Date();
        
        // Guardar el estado en la base de datos
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          const watchState = {
            isWatching: true,
            startTime: watchStartTime.toISOString(),
            movieIndex: currentMovieIndex
          };
          
          await supabase
            .from("users")
            .update({ watch_state: JSON.stringify(watchState) })
            .eq("id", user.id);
        }
        
        // Iniciar el temporizador para 1 hora y 30 minutos
        updateTimer(movieWatchTime);
        watchingTimer = setInterval(() => {
          const elapsedTime = new Date() - watchStartTime;
          const remainingTime = Math.max(0, movieWatchTime - elapsedTime);
          
          if (remainingTime <= 0) {
            clearInterval(watchingTimer);
            document.getElementById("ganar-btn").style.display = "block";
            document.getElementById("timer").innerText = "00:00:00";
          } else {
            updateTimer(remainingTime);
          }
        }, 1000);
      }
    }
    
    async function sumarBalancePeliculas() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      
      const { data: userData, error: fetchError } = await supabase
        .from("users")
        .select("balance")
        .eq("id", user.id)
        .single();
        
      if (fetchError || !userData) {
        console.error("Error al obtener balance:", fetchError);
        return;
      }
      
      const nuevoBalance = parseFloat(userData.balance || 0) + 0.003;
      
      // Actualizar el balance y limpiar el estado de visualización
      const { error: updateError } = await supabase
        .from("users")
        .update({ 
          balance: nuevoBalance,
          watch_state: null
        })
        .eq("id", user.id);
        
      if (updateError) {
        console.error("Error actualizando balance:", updateError);
        return;
      }
      
      // Actualizar estado local
      isWatching = false;
      watchStartTime = null;
      if (watchingTimer) {
        clearInterval(watchingTimer);
        watchingTimer = null;
      }
      
      // Actualizar la interfaz
      document.getElementById("user-balance").textContent = nuevoBalance.toFixed(3);
      document.getElementById("ganar-btn").style.display = "none";
      document.getElementById("timer-container").style.display = "none";
      document.getElementById("ver-btn").textContent = "Ver película nuevamente";
      document.getElementById("ver-btn").disabled = false;
      
      alert("¡Ganaste S/ 0.003 por ver la película!");
    }
    
    window.addEventListener("beforeunload", function(e) {
      if (isWatching) {
        const message = "Estás viendo una película. Si sales ahora, perderás tu progreso.";
        e.returnValue = message;
        return message;
      }
    });
    
    // Función para agregar una nueva película fácilmente
    function agregarPelicula(titulo, urlImagen, urlPelicula, sinopsis, genero, actores = "Actores no disponibles", anio = "2024") {
      peliculas.push({
        titulo,
        imagen: urlImagen,
        url: urlPelicula,
        sinopsis,
        genero,
        actores,
        anio
      });
      
      // Si estás mostrando la lista, actualízala
      if (currentMovieIndex === -1) {
        showMoviesList();
      }
    }
  </script>
</head>
<body>
  <div class="header">
    <h2>Películas 🎬</h2>
    <div class="user-info">
      <p>Usuario: <span id="user-email">Cargando...</span></p>
      <p>Saldo: S/ <span id="user-balance">Cargando...</span></p>
    </div>
  </div>
  
  <div id="main-content">
    <!-- Aquí se cargarán las películas -->
  </div>
</body>
</html>
</antArt>
  </body>
  </html>
