<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Método de Pago</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://srormesvqserhrfugrls.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyb3JtZXN2cXNlcmhyZnVncmxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMzNTk0MzUsImV4cCI6MjA1ODkzNTQzNX0.zGjT9CbTd6jb1lEBzK3OrsZJIgZSqJH9zfLXzWvLTlM";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function guardarMetodoPago() {
            const { data: { user }, error } = await supabase.auth.getUser();

            if (error || !user) {
                alert("Debes iniciar sesión para guardar un método de pago.");
                return;
            }

            const metodo = document.getElementById("metodo").value;
            const valor = document.getElementById("valor").value;

            if (!metodo || !valor) {
                alert("Por favor, ingresa un método de pago y su información.");
                return;
            }

            // Obtener métodos de pago actuales
            const { data, error: userError } = await supabase
                .from('users')
                .select('payment_methods')
                .eq('id', user.id)
                .single();

            let nuevosMetodos = userError ? [] : userError?.payment_methods || [];

            // Eliminar el método si ya existe y agregar el nuevo
            nuevosMetodos = nuevosMetodos.filter(m => m.method !== metodo);
            nuevosMetodos.push({ method: metodo, value: valor });

            // Guardar en la base de datos
            const { error: updateError } = await supabase
                .from('users')
                .update({ payment_methods: nuevosMetodos })
                .eq('id', user.id);

            if (updateError) {
                alert("Error al guardar el método de pago.");
            } else {
                alert("Método de pago guardado correctamente.");
            }
        }
    </script>
</head>
<body>
    <h2>Agregar Método de Pago</h2>
    <label for="metodo">Método:</label>
    <select id="metodo">
        <option value="paypal">PayPal</option>
        <option value="binance">Binance</option>
        <option value="yape">Yape</option>
    </select>
    <br><br>
    <label for="valor">Correo/ID/Número:</label>
    <input type="text" id="valor">
    <br><br>
    <button onclick="guardarMetodoPago()">Guardar Método</button>
</body>
</html>
