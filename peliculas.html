<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Catálogo de Películas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f8f8f8; }
    .pelicula { border: 1px solid #ccc; border-radius: 10px; background: #fff; padding: 16px; margin-bottom: 20px; display: flex; gap: 16px; }
    .pelicula img { width: 150px; border-radius: 10px; }
    .info { flex-grow: 1; }
    .timer { margin-top: 10px; font-weight: bold; color: green; }
    .ver-link { display: none; margin-top: 10px; color: blue; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Bienvenido, <span id="user-email"></span></h1>
  <div id="catalogo"></div>

  <script>
    const supabase = supabase.createClient('https://srormesvqserhrfugrls.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyb3JtZXN2cXNlcmhyZnVncmxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMzNTk0MzUsImV4cCI6MjA1ODkzNTQzNX0.zGjT9CbTd6jb1lEBzK3OrsZJIgZSqJH9zfLXzWvLTlM');
    let userId = null;

    const peliculas = [
      {
        id: "pelicula-1",
        titulo: "El Origen",
        imagen: "https://image.tmdb.org/t/p/w500/a26cQPRhJPX6GbWfQbvZdrrp9j9.jpg",
        categoria: "Ciencia Ficción",
        sinopsis: "Un ladrón que roba secretos corporativos a través del uso de la tecnología de los sueños.",
        url: "https://tuservidor.com/peliculas/origen.mp4"
      },
      {
        id: "pelicula-2",
        titulo: "Titanic",
        imagen: "https://image.tmdb.org/t/p/w500/6VmFqApQRyZZzmiGOQq2C92jyvH.jpg",
        categoria: "Drama / Romance",
        sinopsis: "Una historia épica de amor condenada por la tragedia del Titanic.",
        url: "https://tuservidor.com/peliculas/titanic.mp4"
      }
    ];

    document.addEventListener("DOMContentLoaded", async function () {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        window.location.href = "index.html";
        return;
      }
      userId = user.id;
      document.getElementById("user-email").textContent = user.email;
      cargarCatalogo();
    });

    function cargarCatalogo() {
      const contenedor = document.getElementById("catalogo");
      peliculas.forEach(peli => {
        const div = document.createElement("div");
        div.className = "pelicula";
        div.innerHTML = `
          <img src="${peli.imagen}" alt="${peli.titulo}" />
          <div class="info">
            <h2>${peli.titulo}</h2>
            <p><strong>Categoría:</strong> ${peli.categoria}</p>
            <p>${peli.sinopsis}</p>
            <button onclick="verPelicula('${peli.id}', '${peli.url}')">Ver Película</button>
            <div class="timer" id="timer-${peli.id}"></div>
            <a href="${peli.url}" target="_blank" id="link-${peli.id}" class="ver-link">▶️ Reproducir ahora</a>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    function verPelicula(id, url) {
      const timerEl = document.getElementById(`timer-${id}`);
      const linkEl = document.getElementById(`link-${id}`);
      timerEl.classList.remove("hidden");
      linkEl.style.display = "none";

      const start = Date.now();
      const end = start + (30 * 60 * 1000);

      const interval = setInterval(() => {
        const now = Date.now();
        const restante = end - now;

        if (restante <= 0) {
          clearInterval(interval);
          timerEl.textContent = "✅ Vista completada";
          linkEl.style.display = "inline-block";
          registrarVista();
        } else {
          const minutos = Math.floor(restante / 60000);
          const segundos = Math.floor((restante % 60000) / 1000);
          timerEl.textContent = `Tiempo restante: ${minutos}m ${segundos}s`;
        }
      }, 1000);
    }

    async function registrarVista() {
      const { error } = await supabase
        .from("users")
        .update({
          movie_watch_count: supabase.raw('movie_watch_count + 1'),
          movie_earnings: supabase.raw('movie_earnings + 0.005'),
          movie_view_complete: new Date().toISOString()
        })
        .eq("id", userId);

      if (error) {
        console.error("Error al registrar vista:", error.message);
      } else {
        console.log("Vista registrada correctamente");
      }
    }
  </script>
</body>
</html>
