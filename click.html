<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador de Clics con Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        #container-2537ae2ea8b16bc9e554273a94dfd098 {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            text-align: center;
            min-height: 100px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .timer-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #e2f3f8;
            border-radius: 4px;
            color: #0c5460;
        }
        .validation-timer {
            margin-top: 10px;
            padding: 10px;
            background-color: #ffeeba;
            border-radius: 4px;
            color: #856404;
            font-weight: bold;
            display: none;
        }
        .validation-warning {
            margin-top: 5px;
            font-size: 0.9em;
        }
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Contador de Clics</h1>
    <p><strong>Usuario:</strong> <span id="user-email">Cargando...</span></p>
    <p><strong>Total de Clics:</strong> <span id="click-count">0</span></p>
    <p><strong>Balance:</strong> <span id="balance">0.000</span></p>
    <p><strong>Clics disponibles:</strong> <span id="available-clicks">3</span> de 3</p>
    <div id="timer-info" class="timer-info" style="display: none;">
        Próximo reinicio de clics en: <span id="time-remaining">--:--:--</span>
    </div>
    
    <div id="validation-timer" class="validation-timer">
        Esperando validación: <span id="validation-countdown">20</span> segundos
        <div class="validation-warning">
            ⚠ <strong>No cierres ni cambies de pestaña.</strong> Si abandonas antes de completar el tiempo mínimo, el sistema puede marcar tu acción como inválida.
        </div>
    </div>
    
    <!-- Código del anuncio -->
    <script async="async" data-cfasync="false" src="//pl26063295.effectiveratecpm.com/2537ae2ea8b16bc9e554273a94dfd098/invoke.js"></script>
    <div id="container-2537ae2ea8b16bc9e554273a94dfd098" style="cursor: pointer;"></div>
    
    <button id="logout">Cerrar Sesión</button>
    <div id="status-message" class="status" style="display: none;"></div>

    <script>
        // Debug mode (set to false in production)
        const DEBUG_MODE = true;
        
        // Supabase initialization
        const SUPABASE_URL = "https://srormesvqserhrfugrls.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyb3JtZXN2cXNlcmhyZnVncmxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMzNTk0MzUsImV4cCI6MjA1ODkzNTQzNX0.zGjT9CbTd6jb1lEBzK3OrsZJIgZSqJH9zfLXzWvLTlM";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Constants for click limitation
        const MAX_CLICKS_PER_PERIOD = 3;
        const PERIOD_HOURS = 3;  // Confirmar que son 3 horas, no 7
        const PERIOD_MS = PERIOD_HOURS * 60 * 60 * 1000; // 3 horas en milisegundos
        const VALIDATION_TIME_SECONDS = 20; // Tiempo de validación después de un clic
        
        // Global variables
        let userId = null;
        let userEmail = null;
        let currentClickCount = 0;
        let currentBalance = 0;
        let clicksInPeriod = 0;
        let lastClickTime = null;
        let nextResetTime = null;
        let timerInterval = null;
        let validationInterval = null;
        let validationInProgress = false;
        let validationTimeRemaining = 0;
        let tabFocused = true;
        
        // Debug logging function
        function debugLog(message, data = null) {
            if (!DEBUG_MODE) return;
            
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            let logMessage = `[${timestamp}] ${message}`;
            
            if (data) {
                console.log(logMessage, data);
                logMessage += ' ' + JSON.stringify(data, null, 2);
            } else {
                console.log(logMessage);
            }
        }
        
        // Show status messages
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            
            // Remove all classes
            statusDiv.classList.remove('success', 'error', 'warning');
            
            // Add appropriate class
            if (type === 'error') {
                statusDiv.classList.add('error');
            } else if (type === 'warning') {
                statusDiv.classList.add('warning');
            } else {
                statusDiv.classList.add('success');
            }
            
            statusDiv.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Format time (seconds) to HH:MM:SS
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Calculate and update timer display
        function updateTimerDisplay() {
            if (!nextResetTime) return;
            
            const now = new Date();
            const timeRemaining = Math.max(0, nextResetTime.getTime() - now.getTime());
            const secondsRemaining = Math.ceil(timeRemaining / 1000);
            
            // Update timer display
            const timerElement = document.getElementById('time-remaining');
            timerElement.textContent = formatTime(secondsRemaining);
            
            // If time has expired, reset the click counter
            if (timeRemaining <= 0) {
                debugLog('Período de tiempo expirado, reiniciando contador');
                resetClickPeriod();
            }
        }
        
        // Track tab focus/blur events
        function handleVisibilityChange() {
            if (document.hidden) {
                tabFocused = false;
                debugLog('Tab perdió el foco');
                
                // If validation is in progress, show warning
                if (validationInProgress) {
                    showStatus('⚠️ Has abandonado la página durante la validación. Tu clic podría ser invalidado.', 'warning');
                }
            } else {
                tabFocused = true;
                debugLog('Tab recuperó el foco');
            }
        }
        
        // Start validation timer
        function startValidationTimer() {
            const validationTimerElement = document.getElementById('validation-timer');
            const countdownElement = document.getElementById('validation-countdown');
            
            // Initialize validation state
            validationInProgress = true;
            validationTimeRemaining = VALIDATION_TIME_SECONDS;
            countdownElement.textContent = validationTimeRemaining;
            validationTimerElement.style.display = 'block';
            
            // Disable ad container during validation
            const adContainer = document.getElementById('container-2537ae2ea8b16bc9e554273a94dfd098');
            adContainer.style.pointerEvents = 'none';
            adContainer.style.opacity = '0.5';
            
            // Start countdown
            validationInterval = setInterval(() => {
                validationTimeRemaining--;
                countdownElement.textContent = validationTimeRemaining;
                
                // Check if validation completed
                if (validationTimeRemaining <= 0) {
                    completeValidation(true);
                }
            }, 1000);
            
            debugLog('Temporizador de validación iniciado');
        }
        
        // Complete validation process
        async function completeValidation(success) {
            // Clear validation interval
            clearInterval(validationInterval);
            validationInterval = null;
            
            // Hide validation timer
            document.getElementById('validation-timer').style.display = 'none';
            
            // Update validation state
            validationInProgress = false;
            
            // Check if validation successful
            if (success) {
                debugLog('Validación completada con éxito');
                showStatus('¡Validación completada! Clic registrado correctamente.', 'success');
                
                // Actually commit the click to the database
                try {
                    // Update database
                    const { error } = await supabase
                        .from("users")
                        .update({ 
                            click_count: currentClickCount, 
                            balance: currentBalance,
                            clicks_in_period: clicksInPeriod,
                            last_click_time: lastClickTime.toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .eq("id", userId);
                        
                    if (error) {
                        debugLog('Error al actualizar datos:', error);
                        showStatus('Error al registrar clic: ' + error.message, 'error');
                        
                        // Reload data in case of error
                        await loadUserData();
                    }
                } catch (e) {
                    debugLog('Excepción en completeValidation:', e);
                    showStatus('Error al validar clic: ' + e.message, 'error');
                    await loadUserData(); // Reload data in case of error
                }
            } else {
                debugLog('Validación fallida');
                showStatus('La validación ha fallado. El clic no se registrará.', 'error');
                
                // Undo the local click changes since it wasn't validated
                currentClickCount--;
                currentBalance -= 0.001;
                clicksInPeriod--;
                
                // Update UI with reverted values
                document.getElementById("click-count").textContent = currentClickCount;
                document.getElementById("balance").textContent = currentBalance.toFixed(3);
                
                // Reload user data to ensure everything is in sync
                await loadUserData();
            }
            
            // Re-enable ad container based on available clicks
            updateClickAvailability();
        }
        
        // Check session
        async function checkSession() {
            debugLog('Verificando sesión...');
            
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    debugLog('Error al obtener usuario', error);
                    window.location.href = "index.html"; // Redirect if error
                    return;
                }
                
                if (!user) {
                    debugLog('No hay usuario autenticado');
                    window.location.href = "index.html"; // Redirect if not authenticated
                    return;
                }
                
                userId = user.id;
                userEmail = user.email;
                document.getElementById("user-email").textContent = userEmail;
                
                debugLog('Usuario autenticado:', { id: userId, email: userEmail });
                
                // Initialize user data
                await ensureUserDataInitialized();
                
            } catch (e) {
                debugLog('Excepción en checkSession:', e);
                showStatus('Error al verificar sesión: ' + e.message, 'error');
            }
        }
        
        // Create or ensure user data exists
        async function ensureUserDataInitialized() {
            debugLog('Inicializando datos de usuario...');
            
            try {
                // First, check if user exists in the users table
                const { data, error } = await supabase
                    .from("users")
                    .select("click_count, balance, last_click_time, clicks_in_period")
                    .eq("id", userId)
                    .single();
                
                // Handle case where user doesn't exist in users table
                if (error || !data) {
                    debugLog('Usuario no encontrado en tabla users, creando nuevo registro...', error);
                    
                    // Create new user record
                    const { data: insertData, error: insertError } = await supabase
                        .from("users")
                        .insert({ 
                            id: userId, 
                            email: userEmail,
                            click_count: 0, 
                            balance: 0,
                            clicks_in_period: 0,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .select();
                    
                    if (insertError) {
                        debugLog('Error al crear usuario:', insertError);
                        showStatus('Error al inicializar cuenta: ' + insertError.message, 'error');
                        return false;
                    }
                    
                    debugLog('Usuario creado correctamente', insertData);
                    currentClickCount = 0;
                    currentBalance = 0;
                    clicksInPeriod = 0;
                    
                } else {
                    // User exists, initialize any null fields
                    debugLog('Usuario encontrado en la tabla users', data);
                    
                    // Check if any fields are null and need to be initialized
                    if (data.click_count === null || data.balance === null || data.clicks_in_period === null) {
                        debugLog('Inicializando campos nulos');
                        
                        const updateData = {};
                        if (data.click_count === null) updateData.click_count = 0;
                        if (data.balance === null) updateData.balance = 0;
                        if (data.clicks_in_period === null) updateData.clicks_in_period = 0;
                        
                        const { error: updateError } = await supabase
                            .from("users")
                            .update(updateData)
                            .eq("id", userId);
                        
                        if (updateError) {
                            debugLog('Error al inicializar campos:', updateError);
                            showStatus('Error al inicializar datos: ' + updateError.message, 'error');
                        }
                    }
                }
                
                // Load user data
                await loadUserData();
                return true;
                
            } catch (e) {
                debugLog('Excepción en ensureUserDataInitialized:', e);
                showStatus('Error al inicializar datos: ' + e.message, 'error');
                return false;
            }
        }
        
        // Reset click period for user
        async function resetClickPeriod() {
            debugLog('Reiniciando período de clics');
            
            try {
                // Reset clicks_in_period to 0
                const { error } = await supabase
                    .from("users")
                    .update({ 
                        clicks_in_period: 0,
                        updated_at: new Date().toISOString()
                    })
                    .eq("id", userId);
                
                if (error) {
                    debugLog('Error al reiniciar período de clics:', error);
                    showStatus('Error al reiniciar período: ' + error.message, 'error');
                    return;
                }
                
                // Update local data
                clicksInPeriod = 0;
                nextResetTime = null;
                
                // Update UI
                updateClickAvailability();
                
                showStatus('¡Período de clics reiniciado! Tienes 3 clics disponibles.', 'success');
                
                // Reload user data to ensure everything is in sync
                await loadUserData();
                
            } catch (e) {
                debugLog('Excepción en resetClickPeriod:', e);
                showStatus('Error al reiniciar período: ' + e.message, 'error');
            }
        }
        
        // Update click availability UI
        function updateClickAvailability() {
            const availableClicks = MAX_CLICKS_PER_PERIOD - clicksInPeriod;
            document.getElementById("available-clicks").textContent = Math.max(0, availableClicks);
            
            // Update timer display
            const timerInfoElement = document.getElementById('timer-info');
            
            // Check if period is active - solo mostrar el temporizador cuando se hayan usado los 3 clics
            if (lastClickTime && clicksInPeriod >= MAX_CLICKS_PER_PERIOD) {
                // Calculate next reset time if not already set
                if (!nextResetTime) {
                    nextResetTime = new Date(lastClickTime.getTime() + PERIOD_MS);
                }
                
                // Show timer if se han usado todos los clics
                timerInfoElement.style.display = 'block';
                updateTimerDisplay();
                
                // Start or ensure timer is running
                if (!timerInterval) {
                    timerInterval = setInterval(updateTimerDisplay, 1000);
                }
            } else {
                // Hide timer if hay clics disponibles
                timerInfoElement.style.display = 'none';
                
                // Clear interval if it exists
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }
            
            // Enable/disable ad container
            const adContainer = document.getElementById('container-2537ae2ea8b16bc9e554273a94dfd098');
            
            if (availableClicks <= 0 || validationInProgress) {
                adContainer.style.pointerEvents = 'none';
                adContainer.style.opacity = '0.5';
            } else {
                adContainer.style.pointerEvents = 'auto';
                adContainer.style.opacity = '1';
            }
        }
        
        // Check if we need to reset the period based on time elapsed
        function checkPeriodReset(lastClickTimeStr) {
            if (!lastClickTimeStr) return false;
            
            const lastClick = new Date(lastClickTimeStr);
            const now = new Date();
            const elapsedMs = now.getTime() - lastClick.getTime();
            
            if (elapsedMs >= PERIOD_MS) {
                debugLog('Período de tiempo expirado, reiniciando contador');
                return true;
            }
            
            // Si el período está activo y se han usado todos los clics, configurar el próximo tiempo de reinicio
            if (clicksInPeriod >= MAX_CLICKS_PER_PERIOD) {
                nextResetTime = new Date(lastClick.getTime() + PERIOD_MS);
                debugLog('Próximo reinicio programado para:', nextResetTime);
            }
            
            return false;
        }
        
        // Load user data from database
        async function loadUserData() {
            debugLog('Cargando datos de usuario...');
            
            try {
                const { data, error } = await supabase
                    .from("users")
                    .select("click_count, balance, last_click_time, clicks_in_period")
                    .eq("id", userId)
                    .single();
                
                if (error) {
                    debugLog('Error al cargar datos:', error);
                    showStatus('Error al cargar datos de usuario: ' + error.message, 'error');
                    return;
                }
                
                // Use default values if null
                currentClickCount = data.click_count !== null ? data.click_count : 0;
                currentBalance = data.balance !== null ? data.balance : 0;
                clicksInPeriod = data.clicks_in_period !== null ? data.clicks_in_period : 0;
                lastClickTime = data.last_click_time ? new Date(data.last_click_time) : null;
                
                // Update UI
                document.getElementById("click-count").textContent = currentClickCount;
                document.getElementById("balance").textContent = currentBalance.toFixed(3);
                
                // Check if we need to reset period
                if (data.last_click_time && checkPeriodReset(data.last_click_time)) {
                    await resetClickPeriod();
                } else {
                    // Update click availability
                    updateClickAvailability();
                }
                
                debugLog('Datos cargados correctamente', { 
                    clicks: currentClickCount, 
                    balance: currentBalance,
                    clicksInPeriod: clicksInPeriod,
                    lastClickTime: data.last_click_time
                });
                
            } catch (e) {
                debugLog('Excepción en loadUserData:', e);
                showStatus('Error al cargar datos: ' + e.message, 'error');
            }
        }
        
        // Register click and update database
        async function registerClick() {
            if (!userId) {
                debugLog('No hay ID de usuario al registrar clic');
                return;
            }
            
            // Check if user has available clicks
            if (clicksInPeriod >= MAX_CLICKS_PER_PERIOD) {
                showStatus('Has alcanzado el límite de clics para este período. Espera a que se reinicie el contador.', 'warning');
                return;
            }
            
            // Check if validation is already in progress
            if (validationInProgress) {
                showStatus('Espera a que termine la validación actual.', 'warning');
                return;
            }
            
            debugLog('Iniciando proceso de clic para usuario:', userId);
            
            try {
                // Update local values first (will be committed to database after validation)
                currentClickCount++;
                currentBalance += 0.001; // Add 0.001 to balance
                clicksInPeriod++;
                lastClickTime = new Date();
                
                // Si este es el tercer clic, iniciar el temporizador
                if (clicksInPeriod === MAX_CLICKS_PER_PERIOD) {
                    nextResetTime = new Date(lastClickTime.getTime() + PERIOD_MS);
                    debugLog('Tercer clic alcanzado, temporizador iniciado para:', nextResetTime);
                }
                
                // Update UI immediately to show the click
                document.getElementById("click-count").textContent = currentClickCount;
                document.getElementById("balance").textContent = currentBalance.toFixed(3);
                updateClickAvailability();
                
                // Start validation timer
                startValidationTimer();
                
                const remainingClicks = MAX_CLICKS_PER_PERIOD - clicksInPeriod;
                showStatus(`Clic registrado. Por favor, permanece en la página durante 20 segundos para validar. Te quedan ${remainingClicks} clics disponibles después de validar.`, 'warning');
                
            } catch (e) {
                debugLog('Excepción en registerClick:', e);
                showStatus('Error al registrar clic: ' + e.message, 'error');
                await loadUserData(); // Reload data in case of error
            }
        }
        
        // Logout function
        async function logout() {
            debugLog('Cerrando sesión...');
            
            try {
                // Check if validation is in progress
                if (validationInProgress) {
                    if (confirm('Tienes una validación en curso. Si cierras sesión ahora, perderás ese clic. ¿Deseas continuar?')) {
                        // User confirmed, proceed with logout
                        clearAllTimers();
                        await supabase.auth.signOut();
                        window.location.href = "index.html";
                    }
                } else {
                    // No validation in progress, just logout
                    clearAllTimers();
                    await supabase.auth.signOut();
                    window.location.href = "index.html";
                }
            } catch (e) {
                debugLog('Error al cerrar sesión:', e);
                showStatus('Error al cerrar sesión: ' + e.message, 'error');
            }
        }
        
        // Clear all timers
        function clearAllTimers() {
            // Clear period timer if running
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Clear validation timer if running
            if (validationInterval) {
                clearInterval(validationInterval);
                validationInterval = null;
            }
        }
        
        // Initialize the page
        document.addEventListener("DOMContentLoaded", () => {
            // Check session when page loads
            checkSession();
            
            // Set up tab visibility monitoring
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Event listeners
            document.getElementById("logout").addEventListener("click", logout);
            
            // Ad container click listener
            const adContainer = document.getElementById("container-2537ae2ea8b16bc9e554273a94dfd098");
            adContainer.addEventListener("click", registerClick);
            
            debugLog('Página inicializada');
        });
    </script>
</body>
</html>
